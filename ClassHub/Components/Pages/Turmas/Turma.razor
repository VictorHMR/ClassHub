@page "/turmas/{idTurma:int}"
@using ClassHub.ClassHubContext.Models
@using ClassHub.ClassHubContext.Services
@using ClassHub.Dtos.Turma
@using System.Security.Claims
@using ClassHub.Dtos.Usuario
@inject TurmaService TurmaService
@inject UsuarioService UsuarioService
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer
@attribute [Authorize]

<div class="turma-list-container">
    <h3 class="mb-0"><strong>@turma.Nome</strong></h3>
    <h5 class="mb-0"><strong>Inicio: </strong>@turma.DtInicio.ToShortDateString()</h5>
    <h5 class="mb-3"><strong>Fim: </strong>@turma.DtFim?.ToShortDateString()</h5>



    <h5 class="mb-3"><strong>Integrantes da turma: @integrantes.Count()</strong></h5>

    <div class="d-flex justify-content-between align-items-center flex-wrap mb-2">
        <div class="filtros d-flex gap-2 flex-wrap">
            <select @bind="request.ordenacao" class="form-select w-auto">
                <option value="Ascendente">A-Z</option>
                <option value="Descendente">Z-A</option>
            </select>
            <button class="btn btn-primary" @onclick="CarregarUsuarios">Filtrar</button>
        </div>
        @if (isAdmin)
        {
            <button class="btn btn-success d-flex gap-2 flex-wrap" @onclick="ModalVincularAluno">Vincular Aluno</button>
        }
    </div>


    @if (integrantes == null)
    {
        <p>Carregando alunos...</p>
    }
    else if (!integrantes.Any())
    {
        <p>Nenhum aluno encontrado.</p>
    }
    else
    {
        <div class="row g-1">
            @foreach (var integrante in integrantes)
            {
                <div class="col-6 col-sm-4 col-md-2">
                    <div class="card h-100 shadow-sm p-1" style="font-size:0.75rem;">
                        <div class="card-body d-flex flex-column justify-content-between p-1">
                            @if (integrante.TipoUsuario == Enums.TipoUsuario.Professor)
                            {
                                <h6 class="card-title mb-1 text-primary">
                                    @integrante.Nome
                                </h6>
                                <p class="mb-1" style="font-size:0.7rem;">
                                    <strong>Email:</strong> @integrante.Email
                                </p>
                                <span class="badge bg-primary" style="font-size:0.65rem;">Professor</span>
                            }
                            else
                            {
                                <h6 class="card-title mb-1">
                                    @integrante.Nome
                                </h6>
                                <p class="mb-1" style="font-size:0.7rem;">
                                    <strong>Email:</strong> @integrante.Email <strong>RA:</strong> @integrante.RA
                                </p>
                                <span class="badge bg-transparent" style="font-size:0.65rem;">&nbsp;</span>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>


    }

    @if (paginacao != null && paginacao.TotalPaginas > 1)
    {
        <div class="paginacao mt-3 text-center">
            <button class="btn btn-sm btn-secondary" @onclick="Anterior" disabled="@(request.nrPagina <= 1)">Anterior</button>
            <span class="mx-2">Página @request.nrPagina de @paginacao.TotalPaginas</span>
            <button class="btn btn-sm btn-secondary" @onclick="Proximo" disabled="@(request.nrPagina >= paginacao.TotalPaginas)">Próxima</button>
        </div>
    }

</div>


@code {
    [Parameter] public int idTurma { get; set; }


    private ListarUsuarioRequestDTO request = new()
    {
        nrPagina = 1,
        qtRegistros = 30,
        ordenacao = Enums.Filtros.Ordenacao.Ascendente,
    };
    private PaginacaoResult<UsuarioDTO>? paginacao;
    private IEnumerable<UsuarioDTO>? integrantes;
    private UsuarioDTO? alunoSelecionado;
    private TurmaDTO? turma;
    private bool isAdmin = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.IsInRole("Admin"))
            isAdmin = true;

        request.idTurma = idTurma;
        turma = await TurmaService.ObterTurmaPorId(idTurma);
        await CarregarUsuarios();

        await base.OnInitializedAsync();
    }
    private async Task CarregarUsuarios()
    {
        paginacao = await UsuarioService.ListarUsuarios(request);
        if (paginacao?.Itens != null)
        {
            integrantes = paginacao.Itens
                .OrderByDescending(u => u.TipoUsuario == Enums.TipoUsuario.Professor)
                .ToList();
        }
    }

    private async Task Proximo()
    {
        if (request.nrPagina < paginacao.TotalPaginas)
        {
            request.nrPagina++;
            await CarregarUsuarios();
        }
    }

    private async Task Anterior()
    {
        if (request.nrPagina > 1)
        {
            request.nrPagina--;
            await CarregarUsuarios();
        }
    }

    private async Task ModalVincularAluno()
    {
        
    }
}
